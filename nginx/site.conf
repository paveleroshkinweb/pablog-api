# Should be moved to api gateway if it exist
limit_req_zone $binary_remote_addr zone=pablog_ip_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=ip_addr:10m;
limit_req_status 429;
limit_conn_status 429;

map $status $retry_after {
    default '';
    429 '1000';
}

upstream api_server {
    keepalive 32;
    server unix:/var/run/pablog-service/socket.sock fail_timeout=0;
}

server {
    include           api_json_errors.conf;
    listen            80 default_server;

    default_type      application/json;

    location / {
        access_log off;
        return 444;
    }

    location = /monitor {
        access_log off;
        stub_status;
    }

    location ~ (^/healthcheck|^/docs) {
        access_log     off;
        proxy_redirect off;
        proxy_pass     http://api_server;
    }

    location /api {
        include extra_headers.conf;

        limit_except GET POST PUT PATCH DELETE OPTIONS { deny all; }

        # Should be moved to api gateway if it exist
        limit_req zone=pablog_ip_limit burst=10 nodelay;
        limit_req_log_level warn;
        limit_conn ip_addr 10;

        proxy_redirect off;
        proxy_pass     http://api_server;

    }

}
